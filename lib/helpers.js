'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.listFiles = exports.log = exports.ts = exports.getShopPages = exports.getTarget = exports.shopifyRequest = exports.loadConfig = exports.delay = exports.question = undefined;

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _co = require('co');

var _co2 = _interopRequireDefault(_co);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _machinepackFs = require('machinepack-fs');

var _machinepackFs2 = _interopRequireDefault(_machinepackFs);

var _axios = require('axios');

var _axios2 = _interopRequireDefault(_axios);

var _colors = require('colors');

var _colors2 = _interopRequireDefault(_colors);

var _inquirer = require('inquirer');

var _inquirer2 = _interopRequireDefault(_inquirer);

var _moment = require('moment');

var _moment2 = _interopRequireDefault(_moment);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _dive = require('dive');

var _dive2 = _interopRequireDefault(_dive);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

_bluebird2.default.promisifyAll(_inquirer2.default);

/* global CONFIGVERSION */

var question = exports.question = function (questions) {
  var deferred = _bluebird2.default.pending();
  _inquirer2.default.prompt(questions, function (answers) {
    deferred.resolve(answers);
  });
  return deferred.promise;
};

var delay = exports.delay = function (ms) {
  var deferred = _bluebird2.default.pending();
  setTimeout(function () {
    deferred.resolve();
  }, ms);
  return deferred.promise;
};

var shopify = {
  isRunning: false,
  throttle: 0,
  inFlight: 0,
  rate: 0,
  max: 40,
  queue: []
};

shopify.add = function (item) {
  shopify.queue.push(item);
  if (!shopify.isRunning) {
    shopify.run();
  }
};

shopify.retry = function (item) {
  shopify.queue.unshift(item);
  if (!shopify.isRunning) {
    shopify.run();
  }
};

shopify.run = function () {
  return (0, _co2.default)(function* () {
    shopify.isRunning = true;
    while (shopify.queue.length > 0) {
      let headroom = shopify.max - (shopify.rate + shopify.inFlight);
      if (headroom <= 0) {
        headroom = 0;
      }
      let exponent = headroom * headroom / 9;
      if (exponent <= 0) {
        exponent = 1;
      }

      shopify.throttle = 500 / exponent;

      yield delay(shopify.throttle);
      shopify.request(shopify.queue.shift());
    }
    shopify.isRunning = false;
  });
};

shopify.request = function (item) {
  return (0, _co2.default)(function* () {
    shopify.inFlight += 1;
    var res = yield (0, _axios2.default)(item.request);
    shopify.inFlight -= 1;
    let body = res.data;
    if (body.errors) {
      item.deferred.reject(body.errors);
    } else {
      let limit = res.headers['x-shopify-shop-api-call-limit'];
      limit = limit.split('/');
      shopify.rate = parseInt(_lodash2.default.first(limit), 10);
      shopify.max = parseInt(_lodash2.default.last(limit), 10);

      item.deferred.resolve(res);
    }
  }).catch(function (res) {
    if (_lodash2.default.includes([429], res.status)) {
      shopify.retry(item);
    } else if (_lodash2.default.includes([422], res.status)) {
      let body = res.data;
      if (_lodash2.default.isArray(body.errors.asset)) {
        for (let error of body.errors.asset) {
          console.log(_colors2.default.red(`Error in ${ item.req.filepath } - ${ error }`));
        }
      }
      item.deferred.reject(body.errors);
    } else {
      item.deferred.reject(res);
    }
  });
};

var loadConfig = exports.loadConfig = function () {
  var deferred = _bluebird2.default.pending();
  _machinepackFs2.default.readJson({
    source: 'quickshot.json',
    schema: {}
  }).exec({
    error: deferred.reject,
    doesNotExist: function () {
      deferred.reject(new Error('Shop configuration is missing, have you run \'quickshot configure\'?'));
    },
    couldNotParse: function () {
      deferred.reject(new Error('Shop configuration is corrupt, you may need to delete \'quickshot.json\', and run \'quickshot configure\' again.'));
    },
    success: function (data) {
      if (!data.configVersion || data.configVersion < CONFIGVERSION) {
        deferred.reject(new Error('Shop configuration is from an older incompatible version of quickshot. You need to run \'quickshot configure\' again.'), data);
      }
      deferred.resolve(data);
    }
  });

  return deferred.promise;
};

var shopifyRequest = exports.shopifyRequest = function (req) {
  req.deferred = _bluebird2.default.pending();
  shopify.add(req);
  return req.deferred.promise;
};

var getTarget = exports.getTarget = function* (config, argv) {
  if (argv['target']) {
    var targetName = argv['target'];
  }

  var target = null;
  if (_lodash2.default.isArray(config.targets)) {
    if (targetName) {
      target = _lodash2.default.find(config.targets, { target_name: targetName });
      if (!target) {
        throw new Error(`Could not find target '${ targetName }'`);
      }
    } else {
      var targetChoices = _lodash2.default.map(config.targets, target => {
        return `[${ target.target_name }] - '${ target.theme_name }' at ${ target.domain }.myshopify.com`;
      });
      if (config.targets.length > 1) {
        let choice = yield question([{
          type: 'list',
          name: 'target',
          message: 'Select target',
          default: null,
          choices: targetChoices
        }]);
        target = config.targets[_lodash2.default.indexOf(targetChoices, choice.target)];
      } else if (config.targets.length === 1) {
        target = _lodash2.default.first(config.targets);
      }
    }
  } else {
    throw new Error(`No targets configured! Run 'quickshot configure' and create a new target.`);
  }

  target.auth = 'Basic ' + new Buffer(`${ target.api_key }:${ target.password }`).toString('base64');
  return target;
};

var getShopPages = exports.getShopPages = function* (target) {
  var chunkSize = 250;
  var page = 1;
  var pages = [];
  var pagesBody = {
    pages: [0]
  };

  while (pagesBody.pages.length !== 0) {
    let pagesBody = yield this.shopifyRequest({
      method: 'get',
      url: `https://${ target.api_key }:${ target.password }this.${ target.domain }.myshopify.com/admin/pages.json?limit=${ chunkSize }&page=${ page }`
    });

    pages = pages.concat(pagesBody.pages);
    page += 1;
  }

  return pages;
};

var ts = exports.ts = function () {
  return (0, _moment2.default)().format('hh:mm:ss a');
};

var log = exports.log = function (text) {
  let color = arguments.length <= 1 || arguments[1] === undefined ? 'white' : arguments[1];

  console.log(_colors2.default[color](`${ ts() } - ${ text }`));
};

var listFiles = exports.listFiles = function () {
  let dirPath = arguments.length <= 0 || arguments[0] === undefined ? '' : arguments[0];

  var deferred = _bluebird2.default.pending();
  var files = [];

  (0, _dive2.default)(_path2.default.join(process.cwd(), dirPath), { all: true }, function (err, file) {
    if (err) {
      deferred.reject(err);
    }
    if (file.match(/[\(\)]/)) {
      deferred.reject(new Error(`Filename may not contain parentheses, please rename - "${ file }"`));
    }
    files.push(file);
  }, function () {
    deferred.resolve(files);
  });

  return deferred.promise;
};
//# sourceMappingURL=data:application/json;base64,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QUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsT0FBTyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsVUFBVSxHQUFHLEVBQUUsSUFBSSxFQUFFO0FBQzFFLFFBQUksR0FBRyxFQUFFO0FBQUUsY0FBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtLQUFFO0FBQ2pDLFFBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRTtBQUN4QixjQUFRLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsdURBQXVELEdBQUUsSUFBSSxFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUM5RjtBQUNELFNBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7R0FDakIsRUFBRSxZQUFZO0FBQ2IsWUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQTtHQUN4QixDQUFDLENBQUE7O0FBRUYsU0FBTyxRQUFRLENBQUMsT0FBTyxDQUFBO0NBQ3hCLENBQUEiLCJmaWxlIjoiaGVscGVycy5lczYiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCdcbmltcG9ydCBjbyBmcm9tICdjbydcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQgbWZzIGZyb20gJ21hY2hpbmVwYWNrLWZzJ1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJ1xuaW1wb3J0IGNvbG9ycyBmcm9tICdjb2xvcnMnXG5pbXBvcnQgaW5xdWlyZXIgZnJvbSAnaW5xdWlyZXInXG5pbXBvcnQgbW9tZW50IGZyb20gJ21vbWVudCdcbmltcG9ydCBQcm9taXNlIGZyb20gJ2JsdWViaXJkJ1xuaW1wb3J0IGRpdmUgZnJvbSAnZGl2ZSdcblxuUHJvbWlzZS5wcm9taXNpZnlBbGwoaW5xdWlyZXIpXG5cbi8qIGdsb2JhbCBDT05GSUdWRVJTSU9OICovXG5cbmV4cG9ydCB2YXIgcXVlc3Rpb24gPSBmdW5jdGlvbiAocXVlc3Rpb25zKSB7XG4gIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpXG4gIGlucXVpcmVyLnByb21wdChxdWVzdGlvbnMsIGZ1bmN0aW9uIChhbnN3ZXJzKSB7XG4gICAgZGVmZXJyZWQucmVzb2x2ZShhbnN3ZXJzKVxuICB9KVxuICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZVxufVxuXG5leHBvcnQgdmFyIGRlbGF5ID0gZnVuY3Rpb24gKG1zKSB7XG4gIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpXG4gIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgIGRlZmVycmVkLnJlc29sdmUoKVxuICB9LCBtcylcbiAgcmV0dXJuIGRlZmVycmVkLnByb21pc2Vcbn1cblxudmFyIHNob3BpZnkgPSB7XG4gIGlzUnVubmluZzogZmFsc2UsXG4gIHRocm90dGxlOiAwLFxuICBpbkZsaWdodDogMCxcbiAgcmF0ZTogMCxcbiAgbWF4OiA0MCxcbiAgcXVldWU6IFtdXG59XG5cbnNob3BpZnkuYWRkID0gZnVuY3Rpb24gKGl0ZW0pIHtcbiAgc2hvcGlmeS5xdWV1ZS5wdXNoKGl0ZW0pXG4gIGlmICghc2hvcGlmeS5pc1J1bm5pbmcpIHtcbiAgICBzaG9waWZ5LnJ1bigpXG4gIH1cbn1cblxuc2hvcGlmeS5yZXRyeSA9IGZ1bmN0aW9uIChpdGVtKSB7XG4gIHNob3BpZnkucXVldWUudW5zaGlmdChpdGVtKVxuICBpZiAoIXNob3BpZnkuaXNSdW5uaW5nKSB7XG4gICAgc2hvcGlmeS5ydW4oKVxuICB9XG59XG5cbnNob3BpZnkucnVuID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gY28oZnVuY3Rpb24gKigpIHtcbiAgICBzaG9waWZ5LmlzUnVubmluZyA9IHRydWVcbiAgICB3aGlsZSAoc2hvcGlmeS5xdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgICBsZXQgaGVhZHJvb20gPSBzaG9waWZ5Lm1heCAtIChzaG9waWZ5LnJhdGUgKyBzaG9waWZ5LmluRmxpZ2h0KVxuICAgICAgaWYgKGhlYWRyb29tIDw9IDApIHsgaGVhZHJvb20gPSAwIH1cbiAgICAgIGxldCBleHBvbmVudCA9ICgoaGVhZHJvb20gKiBoZWFkcm9vbSkgLyA5KVxuICAgICAgaWYgKGV4cG9uZW50IDw9IDApIHsgZXhwb25lbnQgPSAxIH1cblxuICAgICAgc2hvcGlmeS50aHJvdHRsZSA9IDUwMCAvIGV4cG9uZW50XG5cbiAgICAgIHlpZWxkIGRlbGF5KHNob3BpZnkudGhyb3R0bGUpXG4gICAgICBzaG9waWZ5LnJlcXVlc3Qoc2hvcGlmeS5xdWV1ZS5zaGlmdCgpKVxuICAgIH1cbiAgICBzaG9waWZ5LmlzUnVubmluZyA9IGZhbHNlXG4gIH0pXG59XG5cbnNob3BpZnkucmVxdWVzdCA9IGZ1bmN0aW9uIChpdGVtKSB7XG4gIHJldHVybiBjbyhmdW5jdGlvbiAqKCkge1xuICAgIHNob3BpZnkuaW5GbGlnaHQgKz0gMVxuICAgIHZhciByZXMgPSB5aWVsZCBheGlvcyhpdGVtLnJlcXVlc3QpXG4gICAgc2hvcGlmeS5pbkZsaWdodCAtPSAxXG4gICAgbGV0IGJvZHkgPSByZXMuZGF0YVxuICAgIGlmIChib2R5LmVycm9ycykge1xuICAgICAgaXRlbS5kZWZlcnJlZC5yZWplY3QoYm9keS5lcnJvcnMpXG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBsaW1pdCA9IHJlcy5oZWFkZXJzWyd4LXNob3BpZnktc2hvcC1hcGktY2FsbC1saW1pdCddXG4gICAgICBsaW1pdCA9IGxpbWl0LnNwbGl0KCcvJylcbiAgICAgIHNob3BpZnkucmF0ZSA9IHBhcnNlSW50KF8uZmlyc3QobGltaXQpLCAxMClcbiAgICAgIHNob3BpZnkubWF4ID0gcGFyc2VJbnQoXy5sYXN0KGxpbWl0KSwgMTApXG5cbiAgICAgIGl0ZW0uZGVmZXJyZWQucmVzb2x2ZShyZXMpXG4gICAgfVxuICB9KS5jYXRjaChmdW5jdGlvbiAocmVzKSB7XG4gICAgaWYgKF8uaW5jbHVkZXMoWzQyOV0sIHJlcy5zdGF0dXMpKSB7XG4gICAgICBzaG9waWZ5LnJldHJ5KGl0ZW0pXG4gICAgfSBlbHNlIGlmIChfLmluY2x1ZGVzKFs0MjJdLCByZXMuc3RhdHVzKSkge1xuICAgICAgbGV0IGJvZHkgPSByZXMuZGF0YVxuICAgICAgaWYgKF8uaXNBcnJheShib2R5LmVycm9ycy5hc3NldCkpIHtcbiAgICAgICAgZm9yIChsZXQgZXJyb3Igb2YgYm9keS5lcnJvcnMuYXNzZXQpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhjb2xvcnMucmVkKGBFcnJvciBpbiAke2l0ZW0ucmVxLmZpbGVwYXRofSAtICR7ZXJyb3J9YCkpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGl0ZW0uZGVmZXJyZWQucmVqZWN0KGJvZHkuZXJyb3JzKVxuICAgIH0gZWxzZSB7XG4gICAgICBpdGVtLmRlZmVycmVkLnJlamVjdChyZXMpXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgdmFyIGxvYWRDb25maWcgPSBmdW5jdGlvbiAoKSB7XG4gIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpXG4gIG1mcy5yZWFkSnNvbih7XG4gICAgc291cmNlOiAncXVpY2tzaG90Lmpzb24nLFxuICAgIHNjaGVtYToge31cbiAgfSkuZXhlYyh7XG4gICAgZXJyb3I6IGRlZmVycmVkLnJlamVjdCxcbiAgICBkb2VzTm90RXhpc3Q6IGZ1bmN0aW9uICgpIHtcbiAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoJ1Nob3AgY29uZmlndXJhdGlvbiBpcyBtaXNzaW5nLCBoYXZlIHlvdSBydW4gXFwncXVpY2tzaG90IGNvbmZpZ3VyZVxcJz8nKSlcbiAgICB9LFxuICAgIGNvdWxkTm90UGFyc2U6IGZ1bmN0aW9uICgpIHtcbiAgICAgIGRlZmVycmVkLnJlamVjdChuZXcgRXJyb3IoJ1Nob3AgY29uZmlndXJhdGlvbiBpcyBjb3JydXB0LCB5b3UgbWF5IG5lZWQgdG8gZGVsZXRlIFxcJ3F1aWNrc2hvdC5qc29uXFwnLCBhbmQgcnVuIFxcJ3F1aWNrc2hvdCBjb25maWd1cmVcXCcgYWdhaW4uJykpXG4gICAgfSxcbiAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgaWYgKCFkYXRhLmNvbmZpZ1ZlcnNpb24gfHwgZGF0YS5jb25maWdWZXJzaW9uIDwgQ09ORklHVkVSU0lPTikge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QobmV3IEVycm9yKCdTaG9wIGNvbmZpZ3VyYXRpb24gaXMgZnJvbSBhbiBvbGRlciBpbmNvbXBhdGlibGUgdmVyc2lvbiBvZiBxdWlja3Nob3QuIFlvdSBuZWVkIHRvIHJ1biBcXCdxdWlja3Nob3QgY29uZmlndXJlXFwnIGFnYWluLicpLCBkYXRhKVxuICAgICAgfVxuICAgICAgZGVmZXJyZWQucmVzb2x2ZShkYXRhKVxuICAgIH1cbiAgfSlcblxuICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZVxufVxuXG5leHBvcnQgdmFyIHNob3BpZnlSZXF1ZXN0ID0gZnVuY3Rpb24gKHJlcSkge1xuICByZXEuZGVmZXJyZWQgPSBQcm9taXNlLnBlbmRpbmcoKVxuICBzaG9waWZ5LmFkZChyZXEpXG4gIHJldHVybiByZXEuZGVmZXJyZWQucHJvbWlzZVxufVxuXG5leHBvcnQgdmFyIGdldFRhcmdldCA9IGZ1bmN0aW9uICooY29uZmlnLCBhcmd2KSB7XG4gIGlmIChhcmd2Wyd0YXJnZXQnXSkge1xuICAgIHZhciB0YXJnZXROYW1lID0gYXJndlsndGFyZ2V0J11cbiAgfVxuXG4gIHZhciB0YXJnZXQgPSBudWxsXG4gIGlmIChfLmlzQXJyYXkoY29uZmlnLnRhcmdldHMpKSB7XG4gICAgaWYgKHRhcmdldE5hbWUpIHtcbiAgICAgIHRhcmdldCA9IF8uZmluZChjb25maWcudGFyZ2V0cywge3RhcmdldF9uYW1lOiB0YXJnZXROYW1lfSlcbiAgICAgIGlmICghdGFyZ2V0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGZpbmQgdGFyZ2V0ICcke3RhcmdldE5hbWV9J2ApXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciB0YXJnZXRDaG9pY2VzID0gXy5tYXAoY29uZmlnLnRhcmdldHMsICh0YXJnZXQpID0+IHsgcmV0dXJuIGBbJHt0YXJnZXQudGFyZ2V0X25hbWV9XSAtICcke3RhcmdldC50aGVtZV9uYW1lfScgYXQgJHt0YXJnZXQuZG9tYWlufS5teXNob3BpZnkuY29tYCB9KVxuICAgICAgaWYgKGNvbmZpZy50YXJnZXRzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgbGV0IGNob2ljZSA9IHlpZWxkIHF1ZXN0aW9uKFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICB0eXBlOiAnbGlzdCcsXG4gICAgICAgICAgICBuYW1lOiAndGFyZ2V0JyxcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdTZWxlY3QgdGFyZ2V0JyxcbiAgICAgICAgICAgIGRlZmF1bHQ6IG51bGwsXG4gICAgICAgICAgICBjaG9pY2VzOiB0YXJnZXRDaG9pY2VzXG4gICAgICAgICAgfVxuICAgICAgICBdKVxuICAgICAgICB0YXJnZXQgPSBjb25maWcudGFyZ2V0c1tfLmluZGV4T2YodGFyZ2V0Q2hvaWNlcywgY2hvaWNlLnRhcmdldCldXG4gICAgICB9IGVsc2UgaWYgKGNvbmZpZy50YXJnZXRzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICB0YXJnZXQgPSBfLmZpcnN0KGNvbmZpZy50YXJnZXRzKVxuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIHRhcmdldHMgY29uZmlndXJlZCEgUnVuICdxdWlja3Nob3QgY29uZmlndXJlJyBhbmQgY3JlYXRlIGEgbmV3IHRhcmdldC5gKVxuICB9XG5cbiAgdGFyZ2V0LmF1dGggPSAnQmFzaWMgJyArIG5ldyBCdWZmZXIoYCR7dGFyZ2V0LmFwaV9rZXl9OiR7dGFyZ2V0LnBhc3N3b3JkfWApLnRvU3RyaW5nKCdiYXNlNjQnKVxuICByZXR1cm4gdGFyZ2V0XG59XG5cbmV4cG9ydCB2YXIgZ2V0U2hvcFBhZ2VzID0gZnVuY3Rpb24gKih0YXJnZXQpIHtcbiAgdmFyIGNodW5rU2l6ZSA9IDI1MFxuICB2YXIgcGFnZSA9IDFcbiAgdmFyIHBhZ2VzID0gW11cbiAgdmFyIHBhZ2VzQm9keSA9IHtcbiAgICBwYWdlczogWzBdXG4gIH1cblxuICB3aGlsZSAocGFnZXNCb2R5LnBhZ2VzLmxlbmd0aCAhPT0gMCkge1xuICAgIGxldCBwYWdlc0JvZHkgPSB5aWVsZCB0aGlzLnNob3BpZnlSZXF1ZXN0KHtcbiAgICAgIG1ldGhvZDogJ2dldCcsXG4gICAgICB1cmw6IGBodHRwczovLyR7dGFyZ2V0LmFwaV9rZXl9OiR7dGFyZ2V0LnBhc3N3b3JkfXRoaXMuJHt0YXJnZXQuZG9tYWlufS5teXNob3BpZnkuY29tL2FkbWluL3BhZ2VzLmpzb24/bGltaXQ9JHtjaHVua1NpemV9JnBhZ2U9JHtwYWdlfWBcbiAgICB9KVxuXG4gICAgcGFnZXMgPSBwYWdlcy5jb25jYXQocGFnZXNCb2R5LnBhZ2VzKVxuICAgIHBhZ2UgKz0gMVxuICB9XG5cbiAgcmV0dXJuIHBhZ2VzXG59XG5cbmV4cG9ydCB2YXIgdHMgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBtb21lbnQoKS5mb3JtYXQoJ2hoOm1tOnNzIGEnKVxufVxuXG5leHBvcnQgdmFyIGxvZyA9IGZ1bmN0aW9uICh0ZXh0LCBjb2xvciA9ICd3aGl0ZScpIHtcbiAgY29uc29sZS5sb2coY29sb3JzW2NvbG9yXShgJHt0cygpfSAtICR7dGV4dH1gKSlcbn1cblxuZXhwb3J0IHZhciBsaXN0RmlsZXMgPSBmdW5jdGlvbiAoZGlyUGF0aCA9ICcnKSB7XG4gIHZhciBkZWZlcnJlZCA9IFByb21pc2UucGVuZGluZygpXG4gIHZhciBmaWxlcyA9IFtdXG5cbiAgZGl2ZShwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgZGlyUGF0aCksIHsgYWxsOiB0cnVlIH0sIGZ1bmN0aW9uIChlcnIsIGZpbGUpIHtcbiAgICBpZiAoZXJyKSB7IGRlZmVycmVkLnJlamVjdChlcnIpIH1cbiAgICBpZiAoZmlsZS5tYXRjaCgvW1xcKFxcKV0vKSkge1xuICAgICAgZGVmZXJyZWQucmVqZWN0KG5ldyBFcnJvcihgRmlsZW5hbWUgbWF5IG5vdCBjb250YWluIHBhcmVudGhlc2VzLCBwbGVhc2UgcmVuYW1lIC0gXCIke2ZpbGV9XCJgKSlcbiAgICB9XG4gICAgZmlsZXMucHVzaChmaWxlKVxuICB9LCBmdW5jdGlvbiAoKSB7XG4gICAgZGVmZXJyZWQucmVzb2x2ZShmaWxlcylcbiAgfSlcblxuICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZVxufVxuIl19